name: Deploy

on:
  push:
    branches:
      - 'main'

jobs:

  deploy_lambda:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
      - name: Setup Node
        uses: actions/setup-node@v2
        with:
          node-version: '18'
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2
      - name: npm install
        env:
          CI: true
          GITHUB_TOKEN: $API_TOKEN
        run: |
          npm install
      - name: deploy
        run: |

          changed_files=$(git diff --name-only HEAD -- 'src/AWS/Lambda/*.ts')

          echo "Changed Files"
          echo "$changed_files"
          # Loop through each changed file and deploy if it belongs to a specific directory
          for file in $changed_files; do
            case $file in
              src/AWS/Lambda/*)
                # Extract the path after 'src/' to use in build and deployment commands
                relative_path=$(echo "$file" | cut -d'/' -f2-) 
                npx ncc build "$file" -o "dist/$relative_path/"
                cd "dist/$relative_path"
                zip "../../../deploy/${relative_path//\//\-}.zip" index.js
                function_name=$(echo "${relative_path//\//\-}" | cut -d'.' -f1)
                aws lambda update-function-code --function-name="$function_name" --zip-file="fileb://dist/${relative_path//\//\-}.zip"
                ;;
              # Add cases for other changed files within src/AWS/Lambda here using similar logic
              # ...
              *)
                echo "Skipping deployment for $file"
                ;;
            esac
          done
          # npx ncc build src/AWS/Lambda/package/post.ts -o dist/AWS/Lambda/package/post/
          # npx ncc build src/AWS/Lambda/package/byName/delete.ts -o dist/AWS/Lambda/package/byName/delete/
          # npx ncc build src/AWS/Lambda/package/byName/get.ts -o dist/AWS/Lambda/package/byName/get/
          # npx ncc build src/AWS/Lambda/package/byRegEx/post.ts -o dist/AWS/Lambda/package/byRegEx/post/
          # npx ncc build src/AWS/Lambda/package/id/rate/get.ts -o dist/AWS/Lambda/package/id/rate/get/
          # npx ncc build src/AWS/Lambda/package/id/delete.ts -o dist/AWS/Lambda/package/id/delete/
          # npx ncc build src/AWS/Lambda/package/id/get.ts -o dist/AWS/Lambda/package/id/get/
          # npx ncc build src/AWS/Lambda/package/id/put.ts -o dist/AWS/Lambda/package/id/put/
          # npx ncc build src/AWS/Lambda/packages/post.ts -o dist/AWS/Lambda/packages/post/
          # npx ncc build src/AWS/Lambda/reset/delete.ts -o dist/AWS/Lambda/reset/delete/

          # mkdir dist/AWS/Lambda/deploy

          # cd dist/AWS/Lambda/package/post
          # zip ../../deploy/package-post.zip index.js 
          
          # cd ../byName/delete
          # zip ../../../deploy/package-byName-delete.zip index.js
          
          # cd ../get
          # zip ../../../deploy/package-byName-get.zip index.js
          
          # cd ../../byRegEx/post
          # zip ../../../deploy/package-byRegEx-post.zip index.js
          
          # cd ../../id/rate/get
          # zip ../../../../deploy/package-id-rate-get.zip index.js

          # cd ../../delete
          # zip ../../../deploy/package-id-delete.zip index.js

          # cd ../../id/get
          # zip ../../../deploy/package-id-get.zip index.js

          # cd ../../id/put
          # zip ../../../deploy/package-id-put.zip index.js
          
          # cd ../../../packages/post
          # zip ../../deploy/packages-post.zip index.js
          
          # cd ../../reset/delete
          # zip ../../deploy/reset-delete.zip index.js

          # cd ../../../../..

          # aws lambda update-function-code --function-name=package-post --zip-file=fileb://dist/AWS/Lambda/deploy/package-post.zip
          # aws lambda update-function-code --function-name=package-byName-delete --zip-file=fileb://dist/AWS/Lambda/deploy/package-byName-delete.zip
          # aws lambda update-function-code --function-name=package-byName-get --zip-file=fileb://dist/AWS/Lambda/deploy/package-byName-get.zip
          # aws lambda update-function-code --function-name=package-byRegEx-post --zip-file=fileb://dist/AWS/Lambda/deploy/package-byRegEx-post.zip
          # aws lambda update-function-code --function-name=package-id-rate-get --zip-file=fileb://dist/AWS/Lambda/deploy/package-id-rate-get.zip
          # aws lambda update-function-code --function-name=package-id-delete --zip-file=fileb://dist/AWS/Lambda/deploy/package-id-delete.zip
          # aws lambda update-function-code --function-name=package-id-get --zip-file=fileb://dist/AWS/Lambda/deploy/package-id-get.zip
          # aws lambda update-function-code --function-name=package-id-put --zip-file=fileb://dist/AWS/Lambda/deploy/package-id-put.zip
          # aws lambda update-function-code --function-name=packages-post --zip-file=fileb://dist/AWS/Lambda/deploy/packages-post.zip
          # aws lambda update-function-code --function-name=reset-delete --zip-file=fileb://dist/AWS/Lambda/deploy/reset-delete.zip
